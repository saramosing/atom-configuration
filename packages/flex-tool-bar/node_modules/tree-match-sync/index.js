var spawn = require('cross-spawn');
var match = require('minimatch');
var path = require('path');

var isWindows = (process.platform === 'win32');

var command;

if(isWindows){
  command = __dirname + '\\bin\\tree.exe';
}else{
  command = 'tree';
}

function escapeRegExp(str) {
    return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

function treeMatch(directory, pattern, options){
  var args = [directory, '-f', '-i', '--noreport'];
  var regex = new RegExp(escapeRegExp(directory) + '/?', 'g');

  var tree;
  var stdout;

  if(options !== undefined && options.maxDepth !== undefined){
    args.push('-L');
    args.push(options.maxDepth);
  }

  tree = spawn.sync(command, args, { stdio: 'pipe' });

  if(tree.status !== 0){
    return {
      status: tree.status,
      stderr: tree.stderr.toString()
    };
  }

  stdout = tree.stdout.toString().replace(regex, '');
  stdout = stdout.replace(/\r/g, '');
  stdout = stdout.split('\n');

  stdout.pop();
  stdout.shift();

  return stdout.filter(match.filter(pattern, options));
}

treeMatch.treeIsInstalled = function(){
  if(isWindows){
    return true;
  }else{
    var which = spawn.sync('which', ['tree'], { stdio: 'pipe' });

    if(which.status !== 0){
      return false;
    }

    return true;
  }
};

module.exports = treeMatch;
